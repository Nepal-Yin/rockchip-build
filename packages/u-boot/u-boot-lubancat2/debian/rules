#!/usr/bin/make -f

include /usr/share/dpkg/architecture.mk
include /usr/share/dpkg/pkg-info.mk

ifneq ($(DEB_BUILD_GNU_TYPE),$(DEB_HOST_GNU_TYPE))
CROSS_COMPILE ?= $(DEB_HOST_GNU_TYPE)-
endif

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
NJOBS := -j $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
else
NJOBS := -j $(shell nproc)
endif

BOARD = lubancat2
BUILD_DIR = debian/build/${BOARD}
TEMP_DIR = debian/tmp/${BOARD}
BINARY_DIR = ${TEMP_DIR}/usr/lib/u-boot-${BOARD}
DOC_DIR = ${TEMP_DIR}/usr/share/doc/u-boot-${BOARD}

lubancat2 : 
	@mkdir -p debian/build/$@
	
	make O=${BUILD_DIR} \
	  CROSS_COMPILE=$(CROSS_COMPILE) \
	  ARCH=arm \
	  $(NJOBS) \
	  evb-rk3568_defconfig

	make O=${BUILD_DIR} \
	  CROSS_COMPILE=$(CROSS_COMPILE) \
	  SOURCE_DATE_EPOCH=$(shell date +%s) \
	  ARCH=arm \
	  $(NJOBS) \
	  BL31=debian/rkbin/rk3568_bl31_v1.36.elf \
	  ROCKCHIP_TPL=debian/rkbin/rk3568_ddr_1560MHz_v1.14.bin

build: lubancat2 

binary-lubancat2:
	rm -rf ${TEMP_DIR}
	mkdir -m 755 -p ${BINARY_DIR}
	cp ${BUILD_DIR}/u-boot.itb ${BINARY_DIR}/u-boot.itb
	cp ${BUILD_DIR}/idbloader.img ${BINARY_DIR}/idbloader.img
	cp ${BUILD_DIR}/u-boot-rockchip.bin ${BINARY_DIR}/u-boot-rockchip.bin

	mkdir -m 755 -p "${TEMP_DIR}/DEBIAN"
	mkdir -p "${DOC_DIR}"
	cp debian/copyright "${DOC_DIR}"
	cp debian/changelog "${DOC_DIR}/changelog.Debian"
	gzip -9 "${DOC_DIR}/changelog.Debian"
	sh -c "cd "${TEMP_DIR}"; find . -type f ! -path './DEBIAN/*' -printf '%P\0' | xargs -r0 md5sum > DEBIAN/md5sums"
	chown -R root:root "${TEMP_DIR}" && chmod -R go-w "${TEMP_DIR}" && chmod -R a+rX "${TEMP_DIR}"
	dpkg-gencontrol -pu-boot-${BOARD} -P"${TEMP_DIR}"
	dpkg --build "${TEMP_DIR}" ..

binary-arch: binary-lubancat2

binary: binary-arch

clean:
	@rm -rf debian/*tmp debian/tmp debian/build debian/files
	$(MAKE) clean
